<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Teamwork</title>

    <link rel=stylesheet href="platform.css" type="text/css">
    <link rel=stylesheet href="libs/jquery/dateField/jquery.dateField.css" type="text/css">

    <link rel=stylesheet href="gantt.css" type="text/css">
    <link rel=stylesheet href="ganttPrint.css" type="text/css" media="print">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <script src="libs/jquery/jquery.livequery.1.1.1.min.js"></script>
    <script src="libs/jquery/jquery.timers.js"></script>

    <script src="libs/utilities.js"></script>
    <script src="libs/forms.js"></script>
    <script src="libs/date.js"></script>
    <script src="libs/dialogs.js"></script>
    <script src="libs/layout.js"></script>
    <script src="libs/i18nJs.js"></script>
    <script src="libs/jquery/dateField/jquery.dateField.js"></script>
    <script src="libs/jquery/JST/jquery.JST.js"></script>
    <script src="libs/watch.js"></script>

    <script type="text/javascript" src="libs/jquery/svg/jquery.svg.min.js"></script>
    <script type="text/javascript" src="libs/jquery/svg/jquery.svgdom.1.8.js"></script>


    <script src="ganttUtilities.js"></script>
    <script src="ganttTask.js"></script>
    <script src="ganttDrawerSVG.js"></script>
    <script src="ganttZoom.js"></script>
    <script src="ganttGridEditor.js"></script>
    <script src="ganttMaster.js"></script>


    <!--<script src="libs/profiling.js"></script>-->
    <!--<script type="text/javascript" src="ganttTestSuite.js"></script>-->
</head>

<body style="background-color: #fff;">


    <div id="ndo" style="position:absolute;right:5px;top:5px;width:378px;padding:5px;background-color: #FFF5E6; border:1px solid #F9A22F; font-size:12px"
        class="noprint">
        This Gantt editor is free thanks to <a href="http://twproject.com" target="_blank">Twproject</a> where it can
        be used on a complete and flexible project management solution.<br> Get your projects done! Give <a href="http://twproject.com"
            target="_blank">Twproject a try now</a>.
    </div>
    <div id="workSpace" style="padding:0px; overflow-y:auto; overflow-x:hidden;border:1px solid #e5e5e5;position:relative;margin:0 5px"></div>

    <style>
        .resEdit {
    padding: 15px;
  }

  .resLine {
    width: 95%;
    padding: 3px;
    margin: 5px;
    border: 1px solid #d0d0d0;
  }

  body {
    overflow: hidden;
  }

  .ganttButtonBar h1{
    color: #000000;
    font-weight: bold;
    font-size: 28px;
    margin-left: 10px;
  }

</style>

    <form id="gimmeBack" style="display:none;" action="../gimmeBack.jsp" method="post" target="_blank"><input type="hidden"
            name="prj" id="gimBaPrj"></form>

    <script type="text/javascript">
        var ge;
        var PRECEDES = "precedes";
        var COLOR_STATUS = "color_status";
        var DEFAULT_COLOR = "#C0C0C0";

        var proxy = 'https://cors-anywhere.herokuapp.com/';
        var server = "http://159.65.9.28/redmine";
        var projectIdentifier = 8;
        var key = "4e46ce6c1275bc5d65e95ad66fc23a7c665767d0";
        var userId = 8;

        window.onbeforeunload = function () {
            if (ge.isChangedTask() || ge.isDeletedTask()) {
                return "Leaving this page will reset the tasks?";
            } else {
                return;
            }
        };

        $(document).ajaxStop(function () {
            console.log("stopppppp");
            loadProject(ge);
            // document.getElementById("saveOnServer").disabled = false;
            ge.disableSaveButton(false);
        });

        // $(document).ajaxStart(function () {
        //     console.log("startttttt");
        //     // document.getElementById("saveOnServer").disabled = true;
        //     ge.disableSaveButton(true);
        // });

        $(function () {
            var canWrite = true; //this is the default for test purposes
            // here starts gantt initialization
            ge = new GanttMaster();
            ge.set100OnClose = true;

            ge.shrinkParent = true;

            ge.init($("#workSpace"));
            loadI18n(); //overwrite with localized ones

            //in order to force compute the best-fitting zoom level
            delete ge.gantt.zoom;

            // var project = loadFromLocalStorage();

            // if (!project.canWrite)
            //     $(".ganttButtonBar button.requireWrite").attr("disabled", "true");
            loadProject(ge);
            console.log("Ge: ", ge);
        });

        function parseColorStatus(colorStatus, mapNameToIdStatus) {
            var mapIdToColor = {};
            var statusToColor = colorStatus.split(",");
            for (var i = 0; i < statusToColor.length; i++){
                var [statusName, colorCode] = statusToColor[i].split(":");
                if (statusName != undefined && statusName != "") {
                    colorCode = colorCode != (undefined||"") ? colorCode : "";
                    var name = statusName.toLowerCase();
                    mapIdToColor[mapNameToIdStatus[name]] = colorCode;
                }
            }
            return mapIdToColor;
        }

        function loadProject(ge) {
            //hardcode server and project identifier
            var projectPath = server + "/projects/" + projectIdentifier + ".json?callback=?";

            var membershipPath = server + "/projects/" + projectIdentifier + "/memberships.json?callback=?";

            var issuePath = server + "/issues.json?status_id=*&project_id=" + projectIdentifier +
                "&include=relations&callback=?";
            var rolePath = server + "/roles.json?callback=?";

            var issueStatusPath = server + "/issue_statuses.json?callback=?";

            var colorStatusPath = proxy + server + "/custom_fields.json?key=" + key;

            $.ajaxSetup({
                global: false
            });

            $.when($.getJSON(projectPath), $.getJSON(membershipPath), $.getJSON(issuePath), $.getJSON(rolePath),
                    $.getJSON(issueStatusPath), $.getJSON(colorStatusPath))
                .then(function (projectRm, memberships, issues, roles, issueStatus, resColorStatus) {

                    var listStatus = issueStatus[0].issue_statuses;
                    //map name to id status
                    var mapNameToIdStatus = {};
                    for (var i = 0; i < listStatus.length; i++) {
                        mapNameToIdStatus[listStatus[i].name.toLowerCase()] = listStatus[i].id;
                    }

                    var mapIdToColor= {};
                    //Map id to Color Status
                    for (var i = 0; i < resColorStatus[0].custom_fields.length; i++) {
                        if (resColorStatus[0].custom_fields[i].name.toLowerCase() == COLOR_STATUS) {
                            var colorStatus = resColorStatus[0].custom_fields[i].default_value;
                            mapIdToColor = parseColorStatus(colorStatus, mapNameToIdStatus);
                        }
                    }

                    //map id to name and color 
                    for (var i = 0; i < listStatus.length; i++) {
                        if (mapIdToColor[listStatus[i].id] != undefined) {
                            listStatus[i].color = mapIdToColor[listStatus[i].id];
                        } else {
                            listStatus[i].color = DEFAULT_COLOR;
                        }
                    }

                    //apply status color in css
                    var style = document.createElement('style');
                    style.type = 'text/css';
                    for (var i = 0; i < listStatus.length; i++) {
                        var st = '.taskStatus[status="' + listStatus[i].id + '"]{background-color: ' + listStatus[i].color + ';}';
                        var stSvg = '.colorByStatus .taskStatusSVG[status="' + listStatus[i].id + '"]{fill: ' + listStatus[i].color + ';}';
                        style.innerHTML += st;
                        style.innerHTML += stSvg;
                        document.head.appendChild(style);
                    }

                    var project = {};

                    //reflect membership/user/resources
                    project.resources = [];
                    // project.resources.push({"name": "me"});
                    console.log("mbs: ", memberships);
                    //map user to rolesg
                    // var userToRole = {};
                    for (var i = 0; i < memberships[0].memberships.length; i++) {
                        if (memberships[0].memberships[i].hasOwnProperty("user")) {
                            project.resources.push(memberships[0].memberships[i].user);
                            if (memberships[0].memberships[i].user.id == userId) {
                                ge.setUser(userId, memberships[0].memberships[i].user.name, memberships[0].memberships[
                                    i].roles);
                            }
                            // userToRole[memberships[0].memberships[i].user.id] = memberships[0].memberships[i].roles;
                        } else if (memberships[0].memberships[i].hasOwnProperty("group")) {
                            project.resources.push(memberships[0].memberships[i].group);
                            // userToRole[memberships[0].memberships[i].group.id] = memberships[0].memberships[i].roles;
                        }
                    }

                    //reflect status
                    project.status = listStatus;
                    // project.status = issueStatus[0].issue_statuses;

                    //reflect role
                    // project.roles = roles[0].roles;
                    project.roles = [{
                            "id": "1",
                            "name": "Người thực hiện"
                        },
                        {
                            "id": "2",
                            "name": "Người theo dõi"
                        }
                    ];

                    //reflect task/issue
                    project.tasks = [];
                    var superiorTask = {
                        "id": "tmp_1",
                        "name": projectRm[0].project.name,
                        "level": 0,
                        "start": (new Date()).getTime(),
                        "end": (new Date()).getTime(),
                    };
                    project.tasks.push(superiorTask);
                    //store all child issue
                    var childQueue = [];
                    var parentIssue = {};
                    for (var i = 0; i < issues[0].issues.length; i++) {
                        parentIssue[issues[0].issues[i].id] = true;
                    }            
                    
                    //sort by parent_id and position
                    issues[0].issues.sort(function(a, b){
                        if (a.hasOwnProperty("parent") && b.hasOwnProperty("parent")) {
                            if (a.parent.id > b.parent.id) {
                                return 1;
                            } else if (a.parent.id < b.parent.id) {
                                return -1;
                            } else {
                                return comparePosition(a.position, b.position);
                            }
                        } else if (!a.hasOwnProperty("parent") && !b.hasOwnProperty("parent")) {
                            return comparePosition(a.position, b.position);
                        } else {
                            return a.hasOwnProperty("parent") ? 1 : -1;
                        }
                        return 0;
                    });

                    // travel all issue 
                    for (var i = 0; i < issues[0].issues.length; i++) {
                        var task = {};

                        var issue = issues[0].issues[i];
                        task.id = issue.id;
                        task.code = issue.id;
                        task.name = issue.subject;
                        task.progress = issue.done_ratio;
                        task.description = issue.description;
                        task.level = 1; //TODO: examine task.level
                        task.status = issue.status.id;
                        task.canWrite = true;
                        task.start = (new Date(issue.start_date)).getTime();
                        task.end = (new Date(issue.due_date).getTime());
                        task.duration = recomputeDuration(task.start, task.end);
                        task.hasChild = false;
                        task.relevance = 0;
                        task.progressByWorklog = false;
                        task.type = "";
                        task.typeId = "";
                        task.depends = "";
                        task.relations = [];
                        
                        //reflect position
                        if (issue.hasOwnProperty("position")) {
                            task.position = issue.position;
                        }

                        //reflect assignees
                        //one task - one user - many role
                        task.assigs = [];
                        if (issue.hasOwnProperty("assigned_to")) {
                            // for (var j = 0; j < userToRole[issue.assigned_to.id].length; j++) {
                            var assig = {};
                            assig.id = "tmp_" + new Date().getTime() + "_" + i;
                            assig.resourceId = issue.assigned_to.id;
                            assig.roleId = 1;
                            task.assigs.push(assig);
                            // }
                        }

                        //relfect custom field
                        task.customFields = [];
                        if (issue.hasOwnProperty("custom_fields")) {
                            task.customFields = issue.custom_fields;
                        }

                        //push all child issue to childQueue
                        if (issue.hasOwnProperty("parent")) {
                            if (!parentIssue.hasOwnProperty(issue.parent.id) || parentIssue[issue.parent.id] == false) {
                                alert("Issue id " + issue.id + " - Cannot find parent id: " + issue.parent.id );
                                return;
                            }
                            task.parent_id = issue.parent.id;
                            childQueue.unshift(task);
                            // childQueue.push(task);
                        } else {
                            project.tasks.push(task);
                        }
                    }

                    //iterate issue to find parent
                    while (childQueue.length > 0) {
                        var task = childQueue.shift();;
                        //check if parent task already in project
                        var [check, level] = checkParent(project, task);
                        if (check < project.tasks.length) {
                            task.level = level + 1;
                            project.tasks[check].hasChild = true;
                            project.tasks.splice(check + 1, 0, task);
                        } else {
                            childQueue.push(task);
                        }
                    }

                    mapDependTask(project.tasks, issues[0].issues);

                    // project.tasks.sort(function (a, b) {
                    //     return a.id - b.id;
                    // });

                    project.canWrite = true;
                    project.canDelete = true;
                    project.canWriteOnParent = true;
                    project.canAdd = true;

                    //demo task
                    // var demoTask = getDemoTask();
                    // for (var i = 0; i < demoTask.length; i++) {
                    //     project.tasks.push(demoTask[i]);
                    // }

                    console.log("Task: ", project);
                    // return;
                    // var project = getDemoProject();

                    if (!project.canWrite)
                        $(".ganttButtonBar button.requireWrite").attr("disabled", "true");
                    ge.loadProject(project);
                    ge.checkpoint(); //empty the undo stack

                }).fail(function (problem) {
                    alert("error when getting project :" + problem.status + " " + problem.statusText + "\n" + problem.responseText);
                    console.log("Problem: ", problem);
                });
        }

        function getTaskPosition(taskId, tasks) {
            for (var i = 0; i < tasks.length; i++) {
                if (tasks[i].id == taskId) {
                    return i;
                }
            }
            return 0;
        }

        function comparePosition(pa, pb) {
            if (pa > pb) {
                return 1;
            } else if (pa < pb) {
                return -1;
            } else {
                return 0;
            }
        }

        function mapDependTask(tasks, issues) {
            for (var i = 0; i < issues.length; i++) {
                var issue = issues[i];
                if (issue.relations.length > 0) {
                    var depends = "";
                    var posIssueToId = getTaskPosition(issue.id, tasks);

                    for (var j = 0; j < issue.relations.length; j++) {
                        var relation = issue.relations[j];
                        if (relation.relation_type == PRECEDES && relation.issue_to_id == issue.id) {
                            //get task position
                            // plus 1 because adding root prject element in editor
                            var posIssueId = getTaskPosition(relation.issue_id, tasks) + 1;
                            if (depends == "") {
                                depends = posIssueId + ":" + relation.delay;
                            } else {
                                depends += "," + posIssueId + ":" + relation.delay;
                            }
                            tasks[posIssueToId].relations.push(relation);
                        }
                    }
                    if (depends != "") {
                        tasks[posIssueToId].depends = depends;
                    }
                }
            }
        }


        function checkParent(project, task) {
            for (var i = 0; i < project.tasks.length; i++) {
                if (task.parent_id == project.tasks[i].id) {
                    return [i, project.tasks[i].level];
                }
            }
            return [project.tasks.length, 0];
        }

        function loadGanttFromServer(taskId, callback) {

            //this is a simulation: load data from the local storage if you have already played with the demo or a textarea with starting demo data
            var ret = loadFromLocalStorage();

            //this is the real implementation
            /*
            //var taskId = $("#taskSelector").val();
            var prof = new Profiler("loadServerSide");
            prof.reset();

            $.getJSON("ganttAjaxController.jsp", {CM:"LOADPROJECT",taskId:taskId}, function(response) {
              //console.debug(response);
              if (response.ok) {
                prof.stop();

                ge.loadProject(response.project);
                ge.checkpoint(); //empty the undo stack

                if (typeof(callback)=="function") {
                  callback(response);
                }
              } else {
                jsonErrorHandling(response);
              }
            });
            */

            return ret;
        }

        function ajaxCreateIssue(server, key, issue, taskQueue, relations, relationsBackward) {
            $.ajax({
                type: 'POST',
                url: proxy + server + '/issues.json' + "?key=" + key,
                data: JSON.stringify(issue),
                dataType: 'text',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('SUCCESS create issue: ', data);
                    var newId = (JSON.parse(data)).issue.id;
                    updateParentId(taskQueue, newId);
                    updateRelationId(issue.issue.id, newId, relations, relationsBackward);
                    handleTask(taskQueue, relations, relationsBackward);
                },
                error: function (data) {
                    alert("ERROR create issue : " + data.status + " " + data.statusText + "\n" + data.responseText);
                    console.log('ERROR create issue: ', data);
                },
            });
        }

        function updateParentId(taskQueue, newParentId) {
            for (var i = 0; i < taskQueue[0].children.length; i++) {
                taskQueue[0].children[i].parent_id = newParentId;
            }
        }

        //poor performance
        function updateRelationId(oldId, newId, relations, relationsBackward) {
            if (relationsBackward[oldId] != undefined) {
                relationsBackward[newId] = [];
                for (var i = 0; i < relationsBackward[oldId].length; i++) {
                    var precedeId = relationsBackward[oldId][i].precede_id;
                    //update newID in relations
                    for (var j = 0; j < relations[precedeId].length; j++) {
                        if (relations[precedeId][j].issue_to_id == oldId) {
                            relations[precedeId][j].issue_to_id = newId;
                        }
                    }

                    var rb = {
                        "precede_id": precedeId
                    };
                    relationsBackward[newId].push({
                        "precede_id": precedeId
                    });
                }
                relationsBackward[oldId] = undefined;
            }

            if (relations[oldId] != undefined) {
                relations[newId] = [];
                for (var i = 0; i < relations[oldId].length; i++) {
                    var issueToId = relations[oldId][i].issue_to_id;
                    //update newID in relationsBackward
                    for (var j = 0; j < relationsBackward[issueToId].length; j++) {
                        if (relationsBackward[issueToId][j].precede_id == oldId) {
                            relationsBackward[issueToId][j].precede_id = newId;
                        }
                    }

                    var r = {
                        "issue_to_id": relations[oldId][i].issue_to_id,
                        "delay": relations[oldId][i].delay,
                        "relation_type": PRECEDES
                    };
                    relations[newId].push(r);
                }
                relations[oldId] = undefined;
            }
        }

        function ajaxUpdateIssue(server, key, issue, taskQueue, relations, relationsBackward) {
            $.ajax({
                type: 'PUT',
                url: proxy + server + '/issues/' + issue.issue.id + '.json' + "?key=" + key,
                data: JSON.stringify(issue),
                dataType: 'text',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('SUCCESS Update issue id: ', issue.issue.id);
                    handleTask(taskQueue, relations, relationsBackward);
                },
                error: function (data) {
                    alert("Error update issue id " + issue.issue.id + ": " + data.status + " " + data.statusText + "\n" + data.responseText);
                    console.log('ERROR Update issue id: ', data);
                },
            });
        }

        function deleteIssues(server, key, issueIds) {
            for (var i = 0; i < issueIds.length; i++) {
                var issueId = issueIds[i];
                ajaxDeleteIssue(server, key, issueId);
            }
        }

        function ajaxDeleteIssue(server, key, issueId) {
            $.ajax({
                type: "DELETE",
                url: proxy + server + '/issues/' + issueId + ".json" + "?key=" + key,
                dataType: 'text',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('SUCCESS Delete issue id: ', issueId);
                },
                error: function (data) {
                    alert("Error delete issue id " + issueId + ": " + data.status + " " + data.statusText + "\n" + data.responseText);
                    console.log('ERROR Delete issue: ', data);
                },
            });
        }

        function ajaxUpdateMembership(server, key, membershipId, membership) {
            $.ajax({
                type: 'PUT',
                url: proxy + server + '/memberships/' + membershipId + '.json' + "?key=" + key,
                data: JSON.stringify(membership),
                dataType: 'text',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('SUCCESS: ', data);
                },
                error: function (data) {
                    console.log('ERROR: ', data);
                },
            });
        }

        function ajaxCreateRelation(server, key, issueId, relation, relationQueue) {
            $.ajax({
                type: 'POST',
                url: proxy + server + '/issues/' + issueId + "/relations.json" + "?key=" + key,
                data: JSON.stringify(relation),
                dataType: 'text',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log('SUCCESS create relation: ', data);
                    handleRelations(relationQueue);
                },
                error: function (data) {
                    alert("ERROR create relation : " + data.status + " " + data.statusText + "\n" + data.responseText);
                    console.log('ERROR create relation: ', data);
                },
            });
        }

        function ajaxDeleteRelation(server, key, relationId) {
            $.ajax({
                type: "DELETE",
                url: proxy + server + '/relations/' + relationId + ".json" + "?key=" + key,
                dataType: 'text',
                contentType: "application/json; charset=utf-8",
                // async: false,
                success: function (data) {
                    console.log('SUCCESS delete relation o: ', relationId + " " + data);
                },
                error: function (data) {
                    alert("ERROR delete relation " + relationId + " : " + data.status + " " + data.statusText + "\n" + data.responseText);
                    console.log('ERROR delete relation: ', data);
                },
            });
        }

        function ajaxDeleteAndCreateRelation(server, key, relationId, issueId, relation) {
            $.ajax({
                type: "DELETE",
                url: proxy + server + '/relations/' + relationId + ".json" + "?key=" + key,
                dataType: 'text',
                contentType: "application/json; charset=utf-8",
                // async: false,
                success: function (data) {
                    console.log('SUCCESS delete relation: ', relationId + " " + data);
                    ajaxCreateRelation(server, key, issueId, relation);
                },
                error: function (xhr, status, error) {
                    if (error = "Not Found") {
                        ajaxCreateRelation(server, key, issueId, relation);
                    } else {
                        console.log('ERROR delete relation: ', error);
                    }
                },
            });
        }

        function saveGanttOnServer() {
            ge.disableSaveButton(true);
            $.ajaxSetup({
                global: true
            });
            //this is a simulation: save data to the local storage or to the textarea
            // saveInLocalStorage();
            //deleted task
            if (ge.deletedTaskIds.length > 0) {
                if (confirm("TASK_THAT_WILL_BE_REMOVED\n" + ge.deletedTaskIds.length)) {
                    //deleted Task
                    deleteIssues(server, key, ge.deletedTaskIds);
                } else {
                    ge.disableSaveButton(false);
                    $.ajaxSetup({
                        global: false
                    });
                    return;
                }
            }

            //up to date Task
            var prj = ge.saveProject();

            console.log("task: ", prj.tasks);
            var [relations, relationsBackward] = buildRelation(prj.tasks);
            console.log("relation: ", relations);
            console.log("relation backward: ", relationsBackward);
            var taskTree = buildTaskTree(prj.tasks);

            var taskQueue = [];
            taskQueue.push(taskTree[0]);
            buildTaskQueue(taskTree[0], taskQueue);

            console.log("task queue : ", taskQueue);
            console.log("taskTree root : ", taskTree);
            console.log("taskTree : ", prj.tasks);
            // return;
            // var res = saveOnServer(taskTree);

            //create or update issue
            handleTask(taskQueue, relations, relationsBackward);
            // createOrUpdateIssue(taskTree[0], relations, relationsBackward);
        }

        function buildRelation(tasks) {
            var relations = {};
            var relationsBackward = {};
            for (var i = 1; i < tasks.length; i++) {
                var task = tasks[i];
                if (task.hasOwnProperty("depends") && task.depends != "") {
                    relationsBackward[task.id] = [];
                    var rel = task.depends.split(",");
                    for (var j = 0; j < rel.length; j++) {
                        var [positionId, delay] = rel[j].split(":");
                        var precedeId = tasks[positionId - 1].id;
                        delay = (delay == undefined) ? 0 : delay;
                        var r = {
                            "issue_to_id": task.id,
                            "delay": delay,
                            "relation_type": PRECEDES
                        };

                        //create or update relation
                        //precedeId and task id exists -> create Or update immediately
                        if (!isNaN(precedeId) && precedeId > 0 && !isNaN(task.id) && task.id > 0) {
                            var relId = 0;
                            var created = true;
                            for (var k = 0; k < task.relations.length; k++) {
                                if (task.relations[k].issue_id == precedeId && task.relations[k].issue_to_id ==
                                    task.id) {
                                    relId = task.relations[k].id;
                                    if (delay == task.relations[k].delay) {
                                        created = false;
                                    }
                                    break;
                                }
                            }

                            if (created) {
                                if (relId > 0) {
                                    ajaxDeleteRelation(server, key, relId);
                                }
                                if (relations[precedeId] == undefined) {
                                    relations[precedeId] = [];
                                }
                                relations[precedeId].push(r);
                            }
                        } else {
                            //else push to object and create after task is created
                            if (relations[precedeId] == undefined) {
                                relations[precedeId] = [];
                            }
                            relations[precedeId].push(r);

                            var rb = {
                                "precede_id": precedeId
                            };
                            relationsBackward[task.id].push(rb);
                        }
                    }
                } else {
                    //delete all relation
                    if (task.hasOwnProperty("relations")) {
                        for (var k = 0; k < task.relations.length; k++) {
                            ajaxDeleteRelation(server, key, task.relations[k].id);
                        }
                    }
                }
            }
            return [relations, relationsBackward];
        }

        function buildTaskQueue(taskTree, taskQueue) {
            if (taskTree.children.length < 1) {
                return;
            }
            for (var i = 0; i < taskTree.children.length; i++) {
                taskQueue.push(taskTree.children[i]);
                buildTaskQueue(taskTree.children[i], taskQueue);
            }
        }

        function buildTaskTree(tasks) {
            var map = {},
                node, roots = [],
                i;
            for (i = 0; i < tasks.length; i++) {
                map[tasks[i].id] = i; // initialize the map
                tasks[i].children = []; // initialize the children
            }
            for (i = 0; i < tasks.length; i++) {
                node = tasks[i];
                if (node.hasOwnProperty("parent_id") && node.parent_id !== "0") {
                    tasks[map[node.parent_id]].children.push(node);
                } else {
                    roots.push(node);
                }
            }
            return roots;
        }

        function buildRelationQueue(relations) {
            var relationQueue = [];
            for (var precedeId in relations) {
                if (relations[precedeId] != undefined) {
                    for (var i = 0; i < relations[precedeId].length; i++) {
                        relationQueue.push({
                            "precedeId": precedeId,
                            "relation": {
                                "relation": relations[precedeId][i]
                            }
                        });
                    }
                }
            }
            return relationQueue;
        }

        function handleRelations(relationQueue) {
            if (relationQueue.length == 0) {
                return;
            }
            var relation = relationQueue.shift();
            console.log("relation: ", relation);

            ajaxCreateRelation(server, key, relation.precedeId, relation.relation, relationQueue);
        }

        function handleTask(taskQueue, relations, relationsBackward) {
            taskQueue.shift();
            if (taskQueue.length == 0) {
                var relationQueue = buildRelationQueue(relations);
                handleRelations(relationQueue);
                return;
            }
            var task = taskQueue[0];

            if (task.change) {
                var issue = {};
                issue.issue = {};

                if (task.hasOwnProperty("id")) {
                    issue.issue.id = task.id;
                }

                if (task.hasOwnProperty("name")) {
                    issue.issue.subject = task.name;
                }

                if (task.hasOwnProperty("progress")) {
                    issue.issue.done_ratio = task.progress;
                }

                if (task.hasOwnProperty("description")) {
                    issue.issue.description = task.description;
                }
                if (task.children.length == 0) {
                    if (task.hasOwnProperty("start")) {
                        issue.issue.start_date = (new Date(task.start)).format("yyyy-MM-dd");
                    }

                    if (task.hasOwnProperty("end")) {
                        issue.issue.due_date = (new Date(task.end)).format("yyyy-MM-dd");
                    }
                }

                if (task.hasOwnProperty("parent_id") && task.level > 1) {
                    issue.issue.parent_issue_id = task.parent_id;
                }

                if (task.hasOwnProperty("status")) {
                    issue.issue.status_id = task.status;
                }

                if (task.hasOwnProperty("position")) {
                    issue.issue.position = task.position;
                }

                if (task.hasOwnProperty("assigs")) {
                    //issue - issue : 1 - 1.
                    //get only the first user
                    //assign only one user
                    if (task.assigs[0] != null) {
                        issue.issue.assigned_to_id = parseInt(task.assigs[0].resourceId, 10);
                    }
                }

                issue.issue.project_id = projectIdentifier;
                if (isNaN(issue.issue.id) || issue.issue.id < 0) {
                    ajaxCreateIssue(server, key, issue, taskQueue, relations, relationsBackward);
                } else {
                    if (task.hasOwnProperty("customFields")) {
                        issue.issue.custom_fields = task.customFields;
                    }
                    ajaxUpdateIssue(server, key, issue, taskQueue, relations, relationsBackward);
                }
            } else {
                handleTask(taskQueue, relations, relationsBackward);
            }
        }

        function createOrUpdateIssue(taskTree, relations, relationsBackward) {
            if (taskTree.children.length < 1) {
                return;
            }

            for (var i = 0; i < taskTree.children.length; i++) {
                var task = taskTree.children[i];

                if (task.change) {
                    var issue = {};
                    issue.issue = {};

                    if (task.hasOwnProperty("id")) {
                        issue.issue.id = task.id;
                    }

                    if (task.hasOwnProperty("name")) {
                        issue.issue.subject = task.name;
                    }

                    if (task.hasOwnProperty("progress")) {
                        issue.issue.done_ratio = task.progress;
                    }

                    if (task.hasOwnProperty("description")) {
                        issue.issue.description = task.description;
                    }
                    if (task.children.length == 0) {
                        if (task.hasOwnProperty("start")) {
                            issue.issue.start_date = (new Date(task.start)).format("yyyy-MM-dd");
                        }

                        if (task.hasOwnProperty("end")) {
                            issue.issue.due_date = (new Date(task.end)).format("yyyy-MM-dd");
                        }
                    }

                    if (task.hasOwnProperty("parent_id") && task.level > 1) {
                        issue.issue.parent_issue_id = task.parent_id;
                    }

                    if (task.hasOwnProperty("status")) {
                        issue.issue.status_id = task.status;
                    }

                    if (task.hasOwnProperty("assigs")) {
                        //issue - issue : 1 - 1.
                        //get only the first user
                        //assign only one user
                        if (task.assigs[0] != null) {
                            issue.issue.assigned_to_id = parseInt(task.assigs[0].resourceId, 10);
                        }
                    }

                    issue.issue.project_id = projectIdentifier;
                    if (isNaN(issue.issue.id) || issue.issue.id < 0) {
                        ajaxCreateIssue(server, key, issue, task, relations, relationsBackward);
                    } else {
                        ajaxUpdateIssue(server, key, issue, task, relations, relationsBackward);
                    }
                } else {
                    createOrUpdateIssue(task, relations, relationsBackward);
                }
            }
        }

        function initRelation(issue_to_id, relation_type, delay) {
            var relation = {};
            relation.relation = {};
            relation.relation.issue_to_id = parseInt(issue_to_id, 10);
            relation.relation.relation_type = relation_type;
            relation.relation.delay = parseInt(delay, 10);
            return relation;
        }

        function getDemoTask() {
            tasks = [{
                    "id": -2,
                    "name": "coding",
                    "progress": 0,
                    "progressByWorklog": false,
                    "relevance": 0,
                    "type": "",
                    "typeId": "",
                    "description": "",
                    "code": "",
                    "level": 1,
                    "status": "1",
                    "depends": "",
                    "canWrite": true,
                    "start": new Date().getTime(),
                    "duration": 1,
                    "end": new Date().getTime(),
                    "startIsMilestone": false,
                    "endIsMilestone": false,
                    "collapsed": false,
                    "assigs": [],
                    "hasChild": true,
                    "relations": []
                },
                {
                    "id": -3,
                    "name": "gantt part",
                    "progress": 0,
                    "progressByWorklog": false,
                    "relevance": 0,
                    "type": "",
                    "typeId": "",
                    "description": "",
                    "code": "",
                    "level": 2,
                    "status": "1",
                    "depends": "4:2",
                    "canWrite": true,
                    "start": new Date().getTime(),
                    "duration": 1,
                    "end": new Date().getTime(),
                    "startIsMilestone": false,
                    "endIsMilestone": false,
                    "collapsed": false,
                    "assigs": [],
                    "hasChild": false,
                    "relations": []
                },
                {
                    "id": -4,
                    "name": "editor part",
                    "progress": 0,
                    "progressByWorklog": false,
                    "relevance": 0,
                    "type": "",
                    "typeId": "",
                    "description": "",
                    "code": "",
                    "level": 2,
                    "status": "1",
                    "depends": "",
                    "canWrite": true,
                    "start": new Date().getTime(),
                    "duration": 1,
                    "end": new Date().getTime(),
                    "startIsMilestone": false,
                    "endIsMilestone": false,
                    "collapsed": false,
                    "assigs": [],
                    "hasChild": false,
                    "relations": []
                },
                {
                    "id": -5,
                    "name": "testing",
                    "progress": 0,
                    "progressByWorklog": false,
                    "relevance": 0,
                    "type": "",
                    "typeId": "",
                    "description": "",
                    "code": "",
                    "level": 1,
                    "status": "1",
                    "depends": "",
                    "canWrite": true,
                    "start": new Date().getTime(),
                    "duration": 1,
                    "end": new Date().getTime(),
                    "startIsMilestone": false,
                    "endIsMilestone": false,
                    "collapsed": false,
                    "assigs": [],
                    "hasChild": true,
                    "relations": []
                },
                {
                    "id": -6,
                    "name": "test on safari",
                    "progress": 0,
                    "progressByWorklog": false,
                    "relevance": 0,
                    "type": "",
                    "typeId": "",
                    "description": "",
                    "code": "",
                    "level": 2,
                    "status": "1",
                    "depends": "3:2",
                    "canWrite": true,
                    "start": new Date().getTime(),
                    "duration": 1,
                    "end": new Date().getTime(),
                    "startIsMilestone": false,
                    "endIsMilestone": false,
                    "collapsed": false,
                    "assigs": [],
                    "hasChild": false,
                    "relations": []
                }, {
                    "id": -7,
                    "name": "test on ie",
                    "progress": 0,
                    "progressByWorklog": false,
                    "relevance": 0,
                    "type": "",
                    "typeId": "",
                    "description": "",
                    "code": "",
                    "level": 2,
                    "status": "1",
                    "depends": "3:1",
                    "canWrite": true,
                    "start": new Date().getTime(),
                    "duration": 1,
                    "end": new Date().getTime(),
                    "startIsMilestone": false,
                    "endIsMilestone": false,
                    "collapsed": false,
                    "assigs": [],
                    "hasChild": false,
                    "relations": []
                }
            ];
            return tasks;
        }

        function getDemoProject() {
            //console.debug("getDemoProject")
            ret = {
                "tasks": [{
                        "id": -1,
                        "name": "Gantt editor",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 0,
                        "status": "STATUS_ACTIVE",
                        "depends": "",
                        "canWrite": true,
                        "start": 1396994400000,
                        "duration": 20,
                        "end": 1399586399999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": true
                    },
                    {
                        "id": -2,
                        "name": "coding",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 1,
                        "status": "STATUS_ACTIVE",
                        "depends": "",
                        "canWrite": true,
                        "start": 1396994400000,
                        "duration": 10,
                        "end": 1398203999999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": true
                    },
                    {
                        "id": -3,
                        "name": "gantt part",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 2,
                        "status": "STATUS_ACTIVE",
                        "depends": "",
                        "canWrite": true,
                        "start": 1396994400000,
                        "duration": 2,
                        "end": 1397167199999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": false
                    },
                    {
                        "id": -4,
                        "name": "editor part",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 2,
                        "status": "STATUS_SUSPENDED",
                        "depends": "3",
                        "canWrite": true,
                        "start": 1397167200000,
                        "duration": 4,
                        "end": 1397685599999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": false
                    },
                    {
                        "id": -5,
                        "name": "testing",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 1,
                        "status": "STATUS_SUSPENDED",
                        "depends": "2:5",
                        "canWrite": true,
                        "start": 1398981600000,
                        "duration": 5,
                        "end": 1399586399999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": true
                    },
                    {
                        "id": -6,
                        "name": "test on safari",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 2,
                        "status": "STATUS_SUSPENDED",
                        "depends": "",
                        "canWrite": true,
                        "start": 1398981600000,
                        "duration": 2,
                        "end": 1399327199999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": false
                    },
                    {
                        "id": -7,
                        "name": "test on ie",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 2,
                        "status": "STATUS_SUSPENDED",
                        "depends": "6",
                        "canWrite": true,
                        "start": 1399327200000,
                        "duration": 3,
                        "end": 1399586399999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": false
                    },
                    {
                        "id": -8,
                        "name": "test on chrome",
                        "progress": 0,
                        "progressByWorklog": false,
                        "relevance": 0,
                        "type": "",
                        "typeId": "",
                        "description": "",
                        "code": "",
                        "level": 2,
                        "status": "STATUS_SUSPENDED",
                        "depends": "6",
                        "canWrite": true,
                        "start": 1399327200000,
                        "duration": 2,
                        "end": 1399499999999,
                        "startIsMilestone": false,
                        "endIsMilestone": false,
                        "collapsed": false,
                        "assigs": [],
                        "hasChild": false
                    }
                ],
                "selectedRow": 2,
                "deletedTaskIds": [],
                "resources": [{
                        "id": "tmp_1",
                        "name": "Resource 1"
                    },
                    {
                        "id": "tmp_2",
                        "name": "Resource 2"
                    },
                    {
                        "id": "tmp_3",
                        "name": "Resource 3"
                    },
                    {
                        "id": "tmp_4",
                        "name": "Resource 4"
                    }
                ],
                "roles": [{
                        "id": "tmp_1",
                        "name": "Project Manager"
                    },
                    {
                        "id": "tmp_2",
                        "name": "Worker"
                    },
                    {
                        "id": "tmp_3",
                        "name": "Stakeholder"
                    },
                    {
                        "id": "tmp_4",
                        "name": "Customer"
                    }
                ],
                "canWrite": true,
                "canDelete": true,
                "canWriteOnParent": true,
                canAdd: true
            }


            //actualize data
            var offset = new Date().getTime() - ret.tasks[0].start;
            for (var i = 0; i < ret.tasks.length; i++) {
                ret.tasks[i].start = ret.tasks[i].start + offset;
            }
            return ret;
        }

        function newProject() {
            clearGantt();
        }


        function clearGantt() {
            ge.reset();
        }

        //-------------------------------------------  Get project file as JSON (used for migrate project from gantt to Teamwork) ------------------------------------------------------
        function getFile() {
            $("#gimBaPrj").val(JSON.stringify(ge.saveProject()));
            $("#gimmeBack").submit();
            $("#gimBaPrj").val("");

            /*  var uriContent = "data:text/html;charset=utf-8," + encodeURIComponent(JSON.stringify(prj));
             neww=window.open(uriContent,"dl");*/
        }


        function loadFromLocalStorage() {
            var ret;
            if (localStorage) {
                if (localStorage.getObject("teamworkGantDemo")) {
                    ret = localStorage.getObject("teamworkGantDemo");
                }
            }

            //if not found create a new example task
            if (!ret || !ret.tasks || ret.tasks.length == 0) {
                ret = getDemoProject();
            }
            return ret;
        }


        function saveInLocalStorage() {
            var prj = ge.saveProject();
            if (localStorage) {
                localStorage.setObject("teamworkGantDemo", prj);
            }
        }


        //-------------------------------------------  Open a black popup for managing resources. This is only an axample of implementation (usually resources come from server) ------------------------------------------------------
        function editResources() {

            //make resource editor
            var resourceEditor = $.JST.createFromTemplate({}, "RESOURCE_EDITOR");
            var resTbl = resourceEditor.find("#resourcesTable");

            for (var i = 0; i < ge.resources.length; i++) {
                var res = ge.resources[i];
                resTbl.append($.JST.createFromTemplate(res, "RESOURCE_ROW"))
            }


            //bind add resource
            resourceEditor.find("#addResource").click(function () {
                resTbl.append($.JST.createFromTemplate({
                    id: "new",
                    name: "resource"
                }, "RESOURCE_ROW"))
            });

            //bind save event
            resourceEditor.find("#resSaveButton").click(function () {
                var newRes = [];
                //find for deleted res
                for (var i = 0; i < ge.resources.length; i++) {
                    var res = ge.resources[i];
                    var row = resourceEditor.find("[resId=" + res.id + "]");
                    if (row.length > 0) {
                        //if still there save it
                        var name = row.find("input[name]").val();
                        if (name && name != "")
                            res.name = name;
                        newRes.push(res);
                    } else {
                        //remove assignments
                        for (var j = 0; j < ge.tasks.length; j++) {
                            var task = ge.tasks[j];
                            var newAss = [];
                            for (var k = 0; k < task.assigs.length; k++) {
                                var ass = task.assigs[k];
                                if (ass.resourceId != res.id)
                                    newAss.push(ass);
                            }
                            task.assigs = newAss;
                        }
                    }
                }

                //loop on new rows
                var cnt = 0
                resourceEditor.find("[resId=new]").each(function () {
                    cnt++;
                    var row = $(this);
                    var name = row.find("input[name]").val();
                    if (name && name != "")
                        newRes.push(new Resource("tmp_" + new Date().getTime() + "_" + cnt,
                            name));
                });

                ge.resources = newRes;

                closeBlackPopup();
                ge.redraw();
            });


            var ndo = createModalPopup(400, 500).append(resourceEditor);
        }

        function setFillter() {
            var filterPopup = $.JST.createFromTemplate({
                status: ge.status,
                assignee: ge.resources
            }, "TASK_FILTER");
            //bind apply event
            filterPopup.find("#applyFilter").click(function () {
                var assigneeId = filterPopup.find("[name=assigneeId]").val();
                assigneeId = assigneeId == "" ? "0" : assigneeId;
                var statusId = filterPopup.find("[name=statusId]").val();
                statusId = statusId == "" ? "0" : statusId;
                ge.filter(assigneeId, statusId);
                closeBlackPopup();
            });

            //bind clear event
            filterPopup.find("#clearFilter").click(function () {
                ge.clearFilter();
                closeBlackPopup();
            });

            var ndo = createModalPopup(400, 230).append(filterPopup);
        }

        function initializeHistoryManagement() {

            //si chiede al server se c'è della hisory per la root
            $.getJSON(contextPath + "/applications/teamwork/task/taskAjaxController.jsp", {
                CM: "GETGANTTHISTPOINTS",
                OBJID: 10236
            }, function (response) {

                //se c'è
                if (response.ok == true && response.historyPoints && response.historyPoints.length > 0) {

                    //si crea il bottone sulla bottoniera
                    var histBtn = $("<button>").addClass("button textual icon lreq30 lreqLabel").attr(
                        "title",
                        "SHOW_HISTORY").append("<span class=\"teamworkIcon\">&#x60;</span>");

                    //al click
                    histBtn.click(function () {
                        var el = $(this);
                        var ganttButtons = $(".ganttButtonBar .buttons");

                        //è gi�  in modalit�  history?
                        if (!ge.element.is(".historyOn")) {
                            ge.element.addClass("historyOn");
                            ganttButtons.find(".requireCanWrite").hide();

                            //si carica la history server side
                            if (false) return;
                            showSavingMessage();
                            $.getJSON(contextPath +
                                "/applications/teamwork/task/taskAjaxController.jsp", {
                                    CM: "GETGANTTHISTPOINTS",
                                    OBJID: ge.tasks[0].id
                                },
                                function (response) {
                                    jsonResponseHandling(response);
                                    hideSavingMessage();
                                    if (response.ok == true) {
                                        var dh = response.historyPoints;
                                        //ge.historyPoints=response.historyPoints;
                                        if (dh && dh.length > 0) {
                                            //si crea il div per lo slider
                                            var sliderDiv = $("<div>").prop("id", "slider")
                                                .addClass(
                                                    "lreq30 lreqHide").css({
                                                    "display": "inline-block",
                                                    "width": "500px"
                                                });
                                            ganttButtons.append(sliderDiv);

                                            var minVal = 0;
                                            var maxVal = dh.length - 1;

                                            $("#slider").show().mbSlider({
                                                rangeColor: '#2f97c6',
                                                minVal: minVal,
                                                maxVal: maxVal,
                                                startAt: maxVal,
                                                showVal: false,
                                                grid: 1,
                                                formatValue: function (val) {
                                                    return new Date(dh[val]).format();
                                                },
                                                onSlideLoad: function (obj) {
                                                    this.onStop(obj);

                                                },
                                                onStart: function (obj) {},
                                                onStop: function (obj) {
                                                    var val = $(obj).mbgetVal();
                                                    showSavingMessage();
                                                    $.getJSON(contextPath +
                                                        "/applications/teamwork/task/taskAjaxController.jsp", {
                                                            CM: "GETGANTTHISTORYAT",
                                                            OBJID: ge.tasks[
                                                                0].id,
                                                            millis: dh[val]
                                                        },
                                                        function (response) {
                                                            jsonResponseHandling
                                                                (
                                                                    response
                                                                );
                                                            hideSavingMessage
                                                                ();
                                                            if (response.ok) {
                                                                ge.baselines =
                                                                    response
                                                                    .baselines;
                                                                ge.showBaselines =
                                                                    true;
                                                                ge.baselineMillis =
                                                                    dh[val];
                                                                ge.redraw();
                                                            }
                                                        })

                                                },
                                                onSlide: function (obj) {
                                                    clearTimeout(obj.renderHistory);
                                                    var self = this;
                                                    obj.renderHistory =
                                                        setTimeout(
                                                            function () {
                                                                self.onStop(obj);
                                                            }, 200)

                                                }
                                            });
                                        }
                                    }
                                });


                            // quando si spenge
                        } else {
                            //si cancella lo slider
                            $("#slider").remove();
                            ge.element.removeClass("historyOn");
                            if (ge.permissions.canWrite)
                                ganttButtons.find(".requireCanWrite").show();

                            ge.showBaselines = false;
                            ge.baselineMillis = undefined;
                            ge.redraw();
                        }

                    });
                    $("#saveGanttButton").before(histBtn);
                }
            })
        }

        function showBaselineInfo(event, element) {
            //alert(element.attr("data-label"));
            $(element).showBalloon(event, $(element).attr("data-label"));
            ge.splitter.secondBox.one("scroll", function () {
                $(element).hideBalloon();
            })
        }
    </script>





    <div id="gantEditorTemplates" style="display:none;">
        <div class="__template__" type="GANTBUTTONS">
            <!--
  <div class="ganttButtonBar noprint">
    <div class="buttons">
      <a href="https://gantt.twproject.com/"><img src="res/twGanttLogo.png" alt="Twproject" align="absmiddle" style="max-width: 136px; padding-right: 15px"></a>

      <button onclick="$('#workSpace').trigger('undo.gantt');return false;" class="button textual icon requireCanWrite" title="undo"><span class="teamworkIcon">&#39;</span></button>
      <button onclick="$('#workSpace').trigger('redo.gantt');return false;" class="button textual icon requireCanWrite" title="redo"><span class="teamworkIcon">&middot;</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanAdd"></span>
      <button onclick="$('#workSpace').trigger('addAboveCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanAdd" title="insert above"><span class="teamworkIcon">l</span></button>
      <button onclick="$('#workSpace').trigger('addBelowCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanAdd" title="insert below"><span class="teamworkIcon">X</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanInOutdent"></span>
      <button onclick="$('#workSpace').trigger('outdentCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanInOutdent" title="un-indent task"><span class="teamworkIcon">.</span></button>
      <button onclick="$('#workSpace').trigger('indentCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanInOutdent" title="indent task"><span class="teamworkIcon">:</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanMoveUpDown"></span>
      <button onclick="$('#workSpace').trigger('moveUpCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanMoveUpDown" title="move up"><span class="teamworkIcon">k</span></button>
      <button onclick="$('#workSpace').trigger('moveDownCurrentTask.gantt');return false;" class="button textual icon requireCanWrite requireCanMoveUpDown" title="move down"><span class="teamworkIcon">j</span></button>
      <span class="ganttButtonSeparator requireCanWrite requireCanDelete"></span>
      <button onclick="$('#workSpace').trigger('deleteFocused.gantt');return false;" class="button textual icon delete requireCanWrite" title="Elimina"><span class="teamworkIcon">&cent;</span></button>
      <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('expandAll.gantt');return false;" class="button textual icon " title="EXPAND_ALL"><span class="teamworkIcon">6</span></button>
      <button onclick="$('#workSpace').trigger('collapseAll.gantt'); return false;" class="button textual icon " title="COLLAPSE_ALL"><span class="teamworkIcon">5</span></button>

    <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('zoomMinus.gantt'); return false;" class="button textual icon " title="zoom out"><span class="teamworkIcon">)</span></button>
      <button onclick="$('#workSpace').trigger('zoomPlus.gantt');return false;" class="button textual icon " title="zoom in"><span class="teamworkIcon">(</span></button>
    <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('print.gantt');return false;" class="button textual icon " title="Print"><span class="teamworkIcon">p</span></button>
    <span class="ganttButtonSeparator"></span>
      <button onclick="ge.gantt.showCriticalPath=!ge.gantt.showCriticalPath; ge.redraw();return false;" class="button textual icon requireCanSeeCriticalPath" title="CRITICAL_PATH"><span class="teamworkIcon">&pound;</span></button>
    <span class="ganttButtonSeparator requireCanSeeCriticalPath"></span>
      <button onclick="ge.splitter.resize(.1);return false;" class="button textual icon" ><span class="teamworkIcon">F</span></button>
      <button onclick="ge.splitter.resize(50);return false;" class="button textual icon" ><span class="teamworkIcon">O</span></button>
      <button onclick="ge.splitter.resize(100);return false;" class="button textual icon"><span class="teamworkIcon">R</span></button>
      <span class="ganttButtonSeparator"></span>
      <button onclick="$('#workSpace').trigger('fullScreen.gantt');return false;" class="button textual icon" title="FULLSCREEN" id="fullscrbtn"><span class="teamworkIcon">@</span></button>
      <button onclick="ge.element.toggleClass('colorByStatus' );return false;" class="button textual icon"><span class="teamworkIcon">&sect;</span></button>
    <button onclick="editResources();" class="button textual requireWrite" title="edit resources"><span class="teamworkIcon">M</span></button>
    <button onclick="setFillter();" class="button textual requireWrite" title="edit resources"><span class="teamworkIcon">&#x66;</span></button>
      
    &nbsp; &nbsp; &nbsp; &nbsp;
    <button onclick="saveGanttOnServer();" id="saveOnServer" class="button first big requireWrite" title="Save">Save</button>
    <button onclick='newProject();' class='button requireWrite newproject'><em>clear project</em></button>
    <button class="button login" title="login/enroll" onclick="loginEnroll($(this));" style="display:none;">login/enroll</button>
    <button class="button opt collab" title="Start with Twproject" onclick="collaborate($(this));" style="display:none;"><em>collaborate</em></button>
    </div></div>
  -->
        </div>

        <div class="__template__" type="TASKSEDITHEAD">
            <!--
  <table class="gdfTable" cellspacing="0" cellpadding="0">
    <thead>
    <tr style="height:40px">
      <th class="gdfColHeader" style="width:35px; border-right: none"></th>
      <th class="gdfColHeader" style="width:25px;"></th>
      <th class="gdfColHeader gdfResizable" style="width:100px;">#</th>
      <th class="gdfColHeader gdfResizable" style="width:300px;">name</th>
      <th class="gdfColHeader"  align="center" style="width:17px;" title="Start date is a milestone."><span class="teamworkIcon" style="font-size: 8px;">^</span></th>
      <th class="gdfColHeader gdfResizable" style="width:80px;">start</th>
      <th class="gdfColHeader"  align="center" style="width:17px;" title="End date is a milestone."><span class="teamworkIcon" style="font-size: 8px;">^</span></th>
      <th class="gdfColHeader gdfResizable" style="width:80px;">End</th>
      <th class="gdfColHeader gdfResizable" style="width:50px;">dur.</th>
      <th class="gdfColHeader gdfResizable" style="width:20px;">%</th>
      <th class="gdfColHeader gdfResizable requireCanSeeDep" style="width:50px;">depe.</th>
      <th class="gdfColHeader gdfResizable" style="width:1000px; text-align: left; padding-left: 10px;">assignees</th>
    </tr>
    </thead>
  </table>
  -->
        </div>

        <div class="__template__" type="TASKROW">
            <!--
  <tr id="tid_(#=obj.id#)" taskId="(#=obj.id#)" class="taskEditRow (#=obj.isParent()?'isParent':''#) (#=obj.collapsed?'collapsed':''#)" level="(#=level#)">
    <th class="gdfCell edit" align="right" style="cursor:pointer;"><span class="taskRowIndex">(#=obj.getRow()+1#)</span> <span class="teamworkIcon" style="font-size:12px;" >e</span></th>
    <td class="gdfCell noClip" align="center"><div class="taskStatus cvcColorSquare" status="(#=obj.status#)"></div></td>
    <td class="gdfCell"><input type="text" name="code" value="(#=obj.code?obj.code:''#)" placeholder="#"></td>
    <td class="gdfCell indentCell" style="padding-left:(#=obj.level*10+18#)px;">
      <div class="exp-controller" align="center"></div>
      <input type="text" name="name" value="(#=obj.name#)" placeholder="name">
    </td>
    <td class="gdfCell" align="center"><input type="checkbox" name="startIsMilestone"></td>
    <td class="gdfCell"><input type="text" name="start"  value="" class="date"></td>
    <td class="gdfCell" align="center"><input type="checkbox" name="endIsMilestone"></td>
    <td class="gdfCell"><input type="text" name="end" value="" class="date"></td>
    <td class="gdfCell"><input type="text" name="duration" autocomplete="off" value="(#=obj.duration#)"></td>
    <td class="gdfCell"><input type="text" name="progress" class="validated" entrytype="PERCENTILE" autocomplete="off" value="(#=obj.progress?obj.progress:''#)" (#=obj.progressByWorklog?"readOnly":""#)></td>
    <td class="gdfCell requireCanSeeDep"><input type="text" name="depends" autocomplete="off" value="(#=obj.depends#)" (#=obj.hasExternalDep?"readonly":""#)></td>
    <td class="gdfCell taskAssigs" id="taskAssigs">(#=obj.getAssigsString()#)</td>
  </tr>
  -->
        </div>

        <div class="__template__" type="TASKEMPTYROW">
            <!--
  <tr class="taskEditRow emptyRow" >
    <th class="gdfCell" align="right"></th>
    <td class="gdfCell noClip" align="center"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell"></td>
    <td class="gdfCell requireCanSeeDep"></td>
    <td class="gdfCell"></td>
  </tr>
  -->
        </div>

        <div class="__template__" type="TASKBAR">
            <!--
  <div class="taskBox taskBoxDiv" taskId="(#=obj.id#)" >
    <div class="layout (#=obj.hasExternalDep?'extDep':''#)">
      <div class="taskStatus" status="(#=obj.status#)"></div>
      <div class="taskProgress" style="width:(#=obj.progress>100?100:obj.progress#)%; background-color:(#=obj.progress>100?'red':'rgb(153,255,51);'#);"></div>
      <div class="milestone (#=obj.startIsMilestone?'active':''#)" ></div>

      <div class="taskLabel"></div>
      <div class="milestone end (#=obj.endIsMilestone?'active':''#)" ></div>
    </div>
  </div>
  -->
        </div>

        <div class="__template__" type="CHANGE_STATUS">
            <!--
        <div class="taskStatusBox">
        </div>
      -->
        </div>

        <div class="__template__" type="TASK_EDITOR">
            <!--
  <div class="ganttTaskEditor">
    <h2 class="taskData">Task editor</h2>
    <table  cellspacing="1" cellpadding="5" width="100%" class="taskData table" id="taskData" border="0">
          <tr>
        <td width="200" style="height: 80px"  valign="top">
          <label for="code">#</label><br>
          <input type="text" name="code" id="code" value="" size=15 class="formElements" autocomplete='off' maxlength=255 style='width:100%' oldvalue="1">
        </td>
        <td colspan="3" valign="top"><label for="name" class="required">name</label><br><input type="text" name="name" id="name"class="formElements" autocomplete='off' maxlength=255 style='width:100%' value="" required="true" oldvalue="1"></td>
          </tr>


      <tr class="dateRow">
        <td nowrap="">
          <div style="position:relative">
            <label for="start">start</label>&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="checkbox" id="startIsMilestone" name="startIsMilestone" value="yes"> &nbsp;<label for="startIsMilestone">is milestone</label>&nbsp;
            <br><input type="text" name="start" id="start" size="8" class="formElements dateField validated date" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DATE">
            <span title="calendar" id="starts_inputDate" class="teamworkIcon openCalendar" onclick="$(this).dateField({inputField:$(this).prevAll(':input:first'),isSearchField:false});">m</span>          </div>
        </td>
        <td nowrap="">
          <label for="end">End</label>&nbsp;&nbsp;&nbsp;&nbsp;
          <input type="checkbox" id="endIsMilestone" name="endIsMilestone" value="yes"> &nbsp;<label for="endIsMilestone">is milestone</label>&nbsp;
          <br><input type="text" name="end" id="end" size="8" class="formElements dateField validated date" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DATE">
          <span title="calendar" id="ends_inputDate" class="teamworkIcon openCalendar" onclick="$(this).dateField({inputField:$(this).prevAll(':input:first'),isSearchField:false});">m</span>
        </td>
        <td nowrap="" >
          <label for="duration" class=" ">Days</label><br>
          <input type="text" name="duration" id="duration" size="4" class="formElements validated durationdays" title="Duration is in working days." autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="DURATIONDAYS">&nbsp;
        </td>
      </tr>

      <tr>
        <td colspan="2" id="taskSelectedStatus">
            <label for="status" class=" ">status</label><br>
        </td>

        <td valign="top" nowrap>
          <label>progress</label><br>
          <input type="text" name="progress" id="progress" size="7" class="formElements validated percentile" autocomplete="off" maxlength="255" value="" oldvalue="1" entrytype="PERCENTILE">
        </td>
      </tr>

          </tr>
          <tr>
            <td colspan="4">
              <label for="description">Description</label><br>
              <textarea rows="3" cols="30" id="description" name="description" class="formElements" style="width:100%"></textarea>
            </td>
          </tr>
        </table>

    <h2>Assignments</h2>
  <table  cellspacing="1" cellpadding="0" width="100%" id="assigsTable">
    <tr>
      <th style="width:80px;">name</th>
      <th style="width:80px;">Role</th>
      <th style="width:40px;">est.wklg.</th>
    </tr>
  </table>


    <h2 class="taskCustomField">Custom Field</h2>
    <table cellspacing="15" cellpadding="0" width="100%" class="taskCustomField table" id="customFieldTable" border="0">
        
    </table>

  <div style="text-align: right; padding-top: 20px">
    <span id="saveButton" class="button first" onClick="$(this).trigger('saveFullEditor.gantt');">Save</span>
  </div>

  </div>
  -->
        </div>


        <div class="__template__" type="SELECTED_STATUS">
            <!--
            <select id="status" name="status"  class="taskStatus" status="(#=obj.task.status#)" onchange="$(this).attr('STATUS',$(this).val());"></select>
            -->
        </div>


        <div class="__template__" type="ASSIGNMENT_ROW">
            <!--
  <tr taskId="(#=obj.task.id#)" assId="(#=obj.assig.id#)" class="assigEditRow" >
    <td style="text-align: center;"><select name="resourceId"  class="formElements" (#=obj.assig.id.indexOf("tmp_")==0?"":"disabled"#) ></select></td>
    <td style="text-align: center;"><select type="select" name="roleId"  class="formElements"></select></td>
    <td style="text-align: center;"><input type="text" name="effort" value="(#=getMillisInHoursMinutes(obj.assig.effort)#)" size="5" class="formElements"></td>
  </tr>
  -->
        </div>



        <div class="__template__" type="RESOURCE_EDITOR">
            <!--
  <div class="resourceEditor" style="padding: 5px;">

    <h2>Project team</h2>
    <table  cellspacing="1" cellpadding="0" width="100%" id="resourcesTable">
      <tr>
        <th style="width:100px;">name</th>
        <th style="width:30px;" id="addResource"><span class="teamworkIcon" style="cursor: pointer">+</span></th>
      </tr>
    </table>

    <div style="text-align: right; padding-top: 20px"><button id="resSaveButton" class="button first">Save</button></div>
  </div>
  -->
        </div>

        <div class="__template__" type="CUSTOM_FIELD_EDITOR">
            <!-- 
            <div class="customFieldEditor" style="padding: 5px;">   
                <h2>Custom Field</h2>
                <table cellspacing="1" cellpadding="0" width="100%" id="customFieldTable">
                    <tr>
                        <th style="width:100px;">name</th>
                        <th style="width:30px;>value</span></th>
                    </tr>
                </table>
            </div>
            -->
        </div>

        <div class="__template__" type="CUSTOM_FIELD_ROW">
            <!--
            <tr taskId="(#=obj.task.id#)" ctfId="(#=obj.ctf.id#)" class="ctfEditRow" >
                <td style="width:30px;"><label for="labelName">(#=obj.ctf.name#)</label></td>
                <td style="width:70px;"><input type="text" name="value" value="(#=obj.ctf.value#)" style="width:100%;" class="formElements"></td>
            </tr>
            -->
        </div>

        <div class="__template__" type="TASK_FILTER">
            <!-- 
                <h2>Filter</h2>
                <table cellspacing="1" cellpadding="0" width="100%" id="filterTable">
                    <tr>
                        <td class="gdfCell" style="text-align:center">
                            Status
                        </td>
                        <td class="gdfCell" style="text-align:center">
                            <select type="select" name="statusId" class="formElements"></select>
                        </td>
                    </tr>

                    <tr>
                        <td class="gdfCell" style="text-align:center">
                            Assignee
                        </td>
                        <td class="gdfCell" style="text-align:center">
                            <select type="select" name="assigneeId" class="formElements"></select>
                        </td>
                    </tr>
                </table>
                <div style="text-align: right; padding-top: 20px">
                    <button id="applyFilter" class="button first">Apply</button>
                    <button id="clearFilter" class="button big">Clear</button>
                </div>
            -->
        </div>

        <div class="__template__" type="RESOURCE_ROW">
            <!--
  <tr resId="(#=obj.id#)" class="resRow" >
    <td ><input type="text" name="name" value="(#=obj.name#)" style="width:100%;" class="formElements"></td>
    <td align="center"><span class="teamworkIcon delRes del" style="cursor: pointer">d</span></td>
  </tr>
  -->
        </div>


    </div>
    <script type="text/javascript">
        $.JST.loadDecorator("RESOURCE_ROW", function (resTr, res) {
            resTr.find(".delRes").click(function () {
                $(this).closest("tr").remove()
            });
        });

        $.JST.loadDecorator("SELECTED_STATUS", function (statusSelected, task) {
            var manager = task.task.master.isManager();
            for (var i = 0; i < task.task.master.status.length; i++) {
                var res = task.task.master.status[i];
                if (!manager && (res.name.toLowerCase() == "Closed".toLowerCase() || res.name.toLowerCase() == "Rejected".toLowerCase())) {
                   continue;
                }
                opt = $("<option>");
                opt.val(res.id).html(res.name);
                if (task.task.status == res.id)
                    opt.attr("selected", "true");
                opt.attr("class", "taskStatus");
                opt.attr("status", res.id);
                statusSelected.append(opt);
            }
        });

        $.JST.loadDecorator("CHANGE_STATUS", function (statusChanged, task) {
            var manager = task.master.isManager();
            
            for (var i = 0; i < task.master.status.length; i++) {
                var res = task.master.status[i];
                if (!manager && (res.name.toLowerCase() == "Closed".toLowerCase() || res.name.toLowerCase() == "Rejected".toLowerCase())) {
                   continue;
                }
                div = $("<div>");
                div.attr("class", "taskStatus cvcColorSquare");
                div.attr("status", res.id);
                div.attr("title", res.name);
                statusChanged.append(div);
            }
        });

        $.JST.loadDecorator("TASK_FILTER", function (resTable, resourceStatus) {
            var statusEl = resTable.find("[name=statusId]");
            var opt = $("<option>");
            statusEl.append(opt);
            for (var i = 0; i < resourceStatus.status.length; i++) {
                var res = resourceStatus.status[i];
                opt = $("<option>");
                opt.val(res.id).html(res.name);
                opt.attr("class", "taskStatus");
                opt.attr("status", res.id);
                statusEl.append(opt);
            }

            var assigneeEl = resTable.find("[name=assigneeId]");
            var opt = $("<option>");
            assigneeEl.append(opt);
            for (var i = 0; i < resourceStatus.assignee.length; i++) {
                var res = resourceStatus.assignee[i];
                opt = $("<option>");
                opt.val(res.id).html(res.name);
                assigneeEl.append(opt);
            }
        });

        $.JST.loadDecorator("ASSIGNMENT_ROW", function (assigTr, taskAssig) {
            var resEl = assigTr.find("[name=resourceId]");
            var opt = $("<option>");
            resEl.append(opt);
            for (var i = 0; i < taskAssig.task.master.resources.length; i++) {
                var res = taskAssig.task.master.resources[i];
                opt = $("<option>");
                opt.val(res.id).html(res.name);
                if (taskAssig.assig.resourceId == res.id)
                    opt.attr("selected", "true");
                resEl.append(opt);
            }
            var roleEl = assigTr.find("[name=roleId]");
            for (var i = 0; i < taskAssig.task.master.roles.length; i++) {
                var role = taskAssig.task.master.roles[i];
                var optr = $("<option>");
                optr.val(role.id).html(role.name);
                if (taskAssig.assig.roleId == role.id)
                    optr.attr("selected", "true");
                roleEl.append(optr);
            }

            // if (taskAssig.task.master.permissions.canWrite && taskAssig.task.canWrite) {
            //     assigTr.find(".delAssig").click(function () {
            //         var tr = $(this).closest("[assId]").fadeOut(200, function () {
            //             $(this).remove()
            //         });
            //     });
            // }

        });


        function loadI18n() {
            GanttMaster.messages = {
                "CANNOT_WRITE": "No permission to change the following task:",
                "CHANGE_OUT_OF_SCOPE": "Project update not possible as you lack rights for updating a parent project.",
                "START_IS_MILESTONE": "Start date is a milestone.",
                "END_IS_MILESTONE": "End date is a milestone.",
                "TASK_HAS_CONSTRAINTS": "Task has constraints.",
                "GANTT_ERROR_DEPENDS_ON_OPEN_TASK": "Error: there is a dependency on an open task.",
                "GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK": "Error: due to a descendant of a closed task.",
                "TASK_HAS_EXTERNAL_DEPS": "This task has external dependencies.",
                "GANNT_ERROR_LOADING_DATA_TASK_REMOVED": "GANNT_ERROR_LOADING_DATA_TASK_REMOVED",
                "CIRCULAR_REFERENCE": "Circular reference.",
                "CANNOT_DEPENDS_ON_ANCESTORS": "Cannot depend on ancestors.",
                "INVALID_DATE_FORMAT": "The data inserted are invalid for the field format.",
                "GANTT_ERROR_LOADING_DATA_TASK_REMOVED": "An error has occurred while loading the data. A task has been trashed.",
                "CANNOT_CLOSE_TASK_IF_OPEN_ISSUE": "Cannot close a task with open issues",
                "TASK_MOVE_INCONSISTENT_LEVEL": "You cannot exchange tasks of different depth.",
                "CANNOT_MOVE_TASK": "CANNOT_MOVE_TASK",
                "PLEASE_SAVE_PROJECT": "PLEASE_SAVE_PROJECT",
                "GANTT_SEMESTER": "Semester",
                "GANTT_SEMESTER_SHORT": "s.",
                "GANTT_QUARTER": "Quarter",
                "GANTT_QUARTER_SHORT": "q.",
                "GANTT_WEEK": "Week",
                "GANTT_WEEK_SHORT": "w."
            };
        }



        function createNewResource(el) {
            var row = el.closest("tr[taskid]");
            var name = row.find("[name=resourceId_txt]").val();
            var url = contextPath + "/applications/teamwork/resource/resourceNew.jsp?CM=ADD&name=" + encodeURI(name);

            openBlackPopup(url, 700, 320, function (response) {
                //fillare lo smart combo
                if (response && response.resId && response.resName) {
                    //fillare lo smart combo e chiudere l'editor
                    row.find("[name=resourceId]").val(response.resId);
                    row.find("[name=resourceId_txt]").val(response.resName).focus().blur();
                }

            });
        }
    </script>






</body>

</html>